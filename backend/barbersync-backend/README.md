# BarberSync Pro - Backend

Sistema de gesti√≥n de citas para barber√≠as desarrollado con NestJS, TypeScript y PostgreSQL con soporte geogr√°fico multi-pa√≠s.

## üÜï Caracter√≠sticas Nuevas

### ‚ú® Sistema de Registro Diferenciado por Roles
- **Clientes**: Registro est√°ndar de 3 pasos
- **Barberos**: Registro + selecci√≥n de barber√≠a existente (4 pasos)
- **Due√±os**: Registro + creaci√≥n completa de barber√≠a (4 pasos)

### üåé Infraestructura Geogr√°fica Multi-Pa√≠s
- **Pa√≠ses soportados**: M√©xico y Colombia
- **Datos disponibles**: 43 regiones y 104 ciudades
- **APIs en cascada**: Pa√≠s ‚Üí Regi√≥n ‚Üí Ciudad ‚Üí Barber√≠a
- **Escalabilidad**: Estructura preparada para m√°s pa√≠ses

## üöÄ Instalaci√≥n y Configuraci√≥n

### Requisitos Previos
- Node.js v18+
- PostgreSQL 14+
- npm o yarn

### Configuraci√≥n del Entorno

```bash
# 1. Instalar dependencias
npm install

# 2. Configurar variables de entorno
cp .env.example .env
# Editar .env con tu configuraci√≥n

# 3. Configurar base de datos
createdb barbersync_dev

# 4. Ejecutar migraciones b√°sicas
npm run migration:run

# 5. üÜï Cargar datos geogr√°ficos (M√©xico y Colombia)
node populate-colombia-data.js
node complete-migration.js

# 6. Verificar datos geogr√°ficos
node verify-both-countries.js

# 7. Iniciar servidor de desarrollo
npm run start:dev
```

## üìä Modelo de Base de Datos Actualizado

### üÜï Estructura Geogr√°fica Multi-Pa√≠s

```mermaid
erDiagram
    REGIONS {
        uuid id PK
        varchar name
        varchar country
        timestamp created_at
        timestamp updated_at
    }
    
    CITIES {
        uuid id PK
        varchar name
        uuid region_id FK
        timestamp created_at
        timestamp updated_at
    }
    
    BARBERSHOPS {
        uuid id PK
        varchar name
        text description
        varchar address
        uuid city_id FK
        varchar neighborhood
        varchar owner_name
        varchar phone
        varchar email
        varchar opening_hours
        boolean is_active
        timestamp created_at
        timestamp updated_at
    }
    
    USERS {
        uuid id PK
        varchar email UK
        varchar password
        varchar firstName
        varchar lastName
        varchar phone
        enum role
        uuid barbershop_id FK
        boolean is_active
        boolean email_verified
        timestamp created_at
        timestamp updated_at
    }

    REGIONS ||--o{ CITIES : "tiene"
    CITIES ||--o{ BARBERSHOPS : "ubica"
    BARBERSHOPS ||--o{ USERS : "emplea"
```

#### üÜï Tablas Geogr√°ficas

**`regions` - Regiones por Pa√≠s**
- **Prop√≥sito**: Gestiona estados/departamentos por pa√≠s
- **Datos**: 10 estados M√©xico + 33 departamentos Colombia
- **√çndices**: (name, country) UNIQUE, country

**`cities` - Ciudades por Regi√≥n**
- **Prop√≥sito**: Ciudades espec√≠ficas dentro de cada regi√≥n
- **Datos**: 22 ciudades M√©xico + 82 ciudades Colombia
- **√çndices**: (name, region_id) UNIQUE, region_id

**`barbershops` - Actualizada con Geolocalizaci√≥n**
- **Nuevos campos**: city_id, neighborhood, owner_name, opening_hours
- **Relaciones**: ManyToOne con cities
- **Validaciones**: city_id debe existir en cities activas

### üîÑ Migraciones Implementadas

#### ‚úÖ Migraci√≥n GeographicOptimization1735684800000
**Archivos principales:**
- `src/database/migrations/002-geographic-optimization.ts`
- `populate-colombia-data.js` - üÜï Datos Colombia
- `complete-migration.js` - Datos M√©xico
- `verify-both-countries.js` - üÜï Verificaci√≥n multi-pa√≠s
- `complete-migration-with-countries.js` - üÜï Script flexible

**Cambios implementados:**
```sql
-- üÜï Nuevas tablas geogr√°ficas
CREATE TABLE regions (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    country VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(name, country)
);

CREATE TABLE cities (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    region_id UUID REFERENCES regions(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(name, region_id)
);

-- üÜï Actualizaciones en barbershops
ALTER TABLE barbershops ADD COLUMN city_id UUID REFERENCES cities(id);
ALTER TABLE barbershops ADD COLUMN neighborhood VARCHAR(255);
ALTER TABLE barbershops ADD COLUMN owner_name VARCHAR(255);
ALTER TABLE barbershops ADD COLUMN opening_hours VARCHAR(255);

-- üÜï √çndices de optimizaci√≥n geogr√°fica
CREATE INDEX idx_regions_country ON regions(country);
CREATE INDEX idx_cities_region_id ON cities(region_id);
CREATE INDEX idx_barbershops_city_id ON barbershops(city_id);
CREATE INDEX idx_barbershops_geographic ON barbershops(city_id, is_active);
```

**üÜï Datos geogr√°ficos iniciales:**

**M√©xico (10 estados, 22 ciudades):**
- Ciudad de M√©xico, Estado de M√©xico, Jalisco, Nuevo Le√≥n
- Puebla, Guanajuato, Veracruz, Yucat√°n, Quintana Roo, Oaxaca

**Colombia (33 departamentos, 82 ciudades):**
- Antioquia, Cundinamarca, Valle del Cauca, Atl√°ntico
- Santander, Bol√≠var, C√≥rdoba, Norte de Santander, etc.

## üõ†Ô∏è Scripts de Utilidad Actualizados

### üÜï Gesti√≥n de Datos Geogr√°ficos
```bash
# Poblar datos de Colombia (33 departamentos + 82 ciudades)
node populate-colombia-data.js

# Migraci√≥n completa multi-pa√≠s
node complete-migration-with-countries.js both

# Solo M√©xico
node complete-migration-with-countries.js mexico

# Solo Colombia  
node complete-migration-with-countries.js colombia

# Verificar datos de ambos pa√≠ses
node verify-both-countries.js

# Verificar solo Colombia
node verify-colombia-data.js
```

### Scripts de Desarrollo
```bash
# Servidor de desarrollo
npm run start:dev

# Construir para producci√≥n
npm run build

# Ejecutar tests
npm run test

# Generar migraci√≥n
npm run migration:generate -- src/database/migrations/MigrationName

# Ejecutar migraciones
npm run migration:run

# Revertir migraci√≥n
npm run migration:revert
```

## üÜï APIs Geogr√°ficas Implementadas

### Endpoints de Geograf√≠a

#### `GET /api/v1/geography/countries`
```json
{
  "countries": ["M√©xico", "Colombia"]
}
```

#### `GET /api/v1/geography/regions?country=Colombia`
```json
{
  "regions": [
    {
      "id": "uuid-antioquia",
      "name": "Antioquia", 
      "country": "Colombia",
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-01T00:00:00Z"
    }
  ]
}
```

#### `GET /api/v1/geography/cities?regionId=uuid-antioquia`
```json
{
  "cities": [
    {
      "id": "uuid-medellin",
      "name": "Medell√≠n",
      "region_id": "uuid-antioquia",
      "region": {
        "name": "Antioquia",
        "country": "Colombia"
      }
    }
  ]
}
```

#### `GET /api/v1/geography/barbershops`
```json
{
  "barbershops": [
    {
      "id": "uuid-barbershop",
      "name": "Barber√≠a El Corte Perfecto",
      "address": "Calle 123 #45-67",
      "neighborhood": "Centro",
      "owner_name": "Juan P√©rez",
      "city": {
        "name": "Medell√≠n",
        "region": {
          "name": "Antioquia",
          "country": "Colombia"
        }
      }
    }
  ]
}
```

## üÜï Sistema de Registro Diferenciado

### M√≥dulos Implementados

#### GeographyModule
**Archivos:**
- `src/modules/geography/geography.module.ts`
- `src/modules/geography/geography.service.ts`
- `src/modules/geography/geography.controller.ts`
- `src/modules/geography/entities/region.entity.ts`
- `src/modules/geography/entities/city.entity.ts`

**Servicios disponibles:**
```typescript
// Obtener pa√≠ses
async getCountries(): Promise<string[]>

// Obtener regiones por pa√≠s
async getRegionsByCountry(country: string): Promise<Region[]>

// Obtener ciudades por regi√≥n
async getCitiesByRegion(regionId: string): Promise<City[]>

// Obtener barber√≠as activas
async getActiveBarbershops(): Promise<Barbershop[]>
```

#### AuthService Actualizado
**Validaciones por rol:**
```typescript
// Cliente - registro est√°ndar
role: 'CLIENT' ‚Üí Sin validaciones adicionales

// Barbero - debe seleccionar barber√≠a existente  
role: 'BARBER' ‚Üí Requiere barbershopId v√°lido

// Due√±o - debe crear barber√≠a completa
role: 'BARBERSHOP_OWNER' ‚Üí Requiere barbershopData con cityId v√°lido
```

**Flujo de creaci√≥n de barber√≠a:**
```typescript
if (role === UserRole.BARBERSHOP_OWNER) {
  // 1. Verificar que la ciudad existe
  const city = await this.cityRepository.findOne({
    where: { id: barbershopData.cityId },
    relations: ['region']
  });
  
  // 2. Crear barber√≠a con datos geogr√°ficos normalizados
  const barbershop = this.barbershopsRepository.create({
    name: barbershopData.name,
    address: barbershopData.address,
    city_id: barbershopData.cityId,
    neighborhood: barbershopData.neighborhood,
    owner_name: `${firstName} ${lastName}`,
    description: `Barber√≠a ubicada en ${city.name}, ${city.region.name}`,
    // ... otros campos
  });
  
  // 3. Asociar usuario con barber√≠a creada
  user.barbershop_id = barbershop.id;
}
```

## üó∫Ô∏è Consultas SQL Optimizadas

### B√∫squedas Geogr√°ficas en Cascada
```sql
-- Obtener regiones por pa√≠s
SELECT id, name FROM regions 
WHERE country = 'Colombia' 
ORDER BY name;

-- Obtener ciudades por regi√≥n
SELECT id, name FROM cities 
WHERE region_id = 'uuid-antioquia' 
ORDER BY name;

-- Obtener barber√≠as con ubicaci√≥n completa
SELECT b.*, c.name as city_name, r.name as region_name, r.country
FROM barbershops b
JOIN cities c ON b.city_id = c.id
JOIN regions r ON c.region_id = r.id
WHERE r.country = 'Colombia' AND b.is_active = true;
```

### Estad√≠sticas Geogr√°ficas
```sql
-- Estad√≠sticas por pa√≠s
SELECT 
    r.country,
    COUNT(DISTINCT r.id) as regions,
    COUNT(DISTINCT c.id) as cities,
    COUNT(DISTINCT b.id) as barbershops
FROM regions r
LEFT JOIN cities c ON r.id = c.region_id
LEFT JOIN barbershops b ON c.id = b.city_id AND b.is_active = true
GROUP BY r.country;

-- Distribuci√≥n por regi√≥n
SELECT 
    r.name as region,
    r.country,
    COUNT(DISTINCT c.id) as cities,
    COUNT(DISTINCT b.id) as barbershops
FROM regions r
LEFT JOIN cities c ON r.id = c.region_id
LEFT JOIN barbershops b ON c.id = b.city_id AND b.is_active = true
GROUP BY r.id, r.name, r.country
ORDER BY r.country, barbershops DESC;
```

## üìÅ Estructura del Proyecto Actualizada

```
src/
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 001-initial-schema.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 002-geographic-optimization.ts    # üÜï Migraci√≥n geogr√°fica
‚îÇ   ‚îî‚îÄ‚îÄ data-source.ts
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dto/register.dto.ts               # üÜï Validaciones por rol
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.service.ts                   # üÜï Registro diferenciado  
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth.module.ts                    # üÜï Include City entity
‚îÇ   ‚îú‚îÄ‚îÄ geography/                            # üÜï M√≥dulo completo
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ geography.module.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ geography.service.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ geography.controller.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ region.entity.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ city.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îú‚îÄ‚îÄ barbershops/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ entities/barbershop.entity.ts     # üÜï Campos geogr√°ficos
‚îÇ   ‚îî‚îÄ‚îÄ appointments/
‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îú‚îÄ‚îÄ enums/user-role.enum.ts               # üÜï Roles actualizados
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ main.ts

scripts/                                      # üÜï Scripts geogr√°ficos
‚îú‚îÄ‚îÄ populate-colombia-data.js                 # Colombia: 33 deps + 82 ciudades
‚îú‚îÄ‚îÄ verify-colombia-data.js                   # Verificar Colombia
‚îú‚îÄ‚îÄ complete-migration-with-countries.js      # Script flexible multi-pa√≠s
‚îú‚îÄ‚îÄ verify-both-countries.js                  # Verificar M√©xico + Colombia
‚îú‚îÄ‚îÄ complete-migration.js                     # M√©xico (original)
‚îî‚îÄ‚îÄ README-SCRIPTS.md                         # üÜï Documentaci√≥n scripts
```

## üîê Seguridad Actualizada

### Validaciones por Rol
- **DTOs diferenciados**: Validaciones espec√≠ficas seg√∫n UserRole
- **Validaci√≥n UUID**: city_id y barbershop_id con formato UUID v4
- **Integridad referencial**: Verificaci√≥n de existencia de ciudades/barber√≠as
- **Sanitizaci√≥n geogr√°fica**: Datos normalizados autom√°ticamente

### Autenticaci√≥n Mejorada
- **JWT con informaci√≥n geogr√°fica**: Token incluye barbershop con ubicaci√≥n
- **RBAC geogr√°fico**: Permisos basados en ubicaci√≥n de barber√≠a
- **Validaci√≥n en cascada**: Verificaci√≥n pa√≠s ‚Üí regi√≥n ‚Üí ciudad

## üèóÔ∏è Arquitectura Actualizada

### Capas del Sistema
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       Geography APIs                ‚îÇ  ‚Üê üÜï Endpoints geogr√°ficos
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ       Auth Controller               ‚îÇ  ‚Üê üÜï Registro diferenciado
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ        Auth Service                 ‚îÇ  ‚Üê üÜï Validaciones por rol
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ      Geography Service              ‚îÇ  ‚Üê üÜï L√≥gica geogr√°fica
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ    Geographic Repositories          ‚îÇ  ‚Üê üÜï Acceso datos geo
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ      PostgreSQL Database            ‚îÇ  ‚Üê üÜï Modelo normalizado
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üÜï M√≥dulos Principales Actualizados
- **GeographyModule**: üÜï Gesti√≥n completa de ubicaci√≥n
- **AuthModule**: üÜï Registro diferenciado por roles
- **UsersModule**: üÜï Relaci√≥n con barber√≠as geogr√°ficas
- **BarbershopsModule**: üÜï Ubicaci√≥n normalizada

## üöÄ Despliegue

### Variables de Entorno Requeridas
```env
# Database
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=barbersync_user
DB_PASSWORD=tu_password
DB_DATABASE=barbersync_dev

# JWT
JWT_SECRET=tu_jwt_secret_key
JWT_EXPIRES_IN=7d

# Application
PORT=3001
NODE_ENV=development

# üÜï Geographic Data
SUPPORTED_COUNTRIES=M√©xico,Colombia
DEFAULT_COUNTRY=M√©xico
```

### Comandos de Despliegue
```bash
# Build para producci√≥n
npm run build

# üÜï Setup completo con datos geogr√°ficos
npm run migration:run
node populate-colombia-data.js
node complete-migration.js

# Verificar antes de producci√≥n
node verify-both-countries.js

# Iniciar en producci√≥n
npm run start:prod
```

## üìà Estad√≠sticas Actuales

### Datos Geogr√°ficos Disponibles
- **2 pa√≠ses**: M√©xico, Colombia
- **43 regiones**: 10 estados + 33 departamentos
- **104 ciudades**: 22 ciudades mexicanas + 82 colombianas
- **APIs optimizadas**: < 100ms promedio por consulta
- **Escalabilidad**: Estructura lista para m√°s pa√≠ses

### Performance del Sistema
- **Registro diferenciado**: < 200ms incluyendo validaciones
- **Consultas en cascada**: < 50ms por nivel geogr√°fico
- **B√∫squeda de barber√≠as**: < 150ms con datos completos
- **√çndices optimizados**: Queries geogr√°ficas eficientes

## üîÑ Roadmap de Expansi√≥n

### Pr√≥ximos Pa√≠ses
- **Argentina**: Buenos Aires, C√≥rdoba, Rosario, etc.
- **Per√∫**: Lima, Arequipa, Trujillo, etc.
- **Chile**: Santiago, Valpara√≠so, Concepci√≥n, etc.

### Mejoras Planificadas
- **Geocodificaci√≥n**: Coordenadas lat/lng autom√°ticas
- **B√∫squeda por proximidad**: Barber√≠as cercanas
- **Multi-idioma**: Soporte i18n por pa√≠s
- **Zonas horarias**: Gesti√≥n autom√°tica por ubicaci√≥n

## ü§ù Contribuci√≥n

1. Fork del repositorio
2. Crear feature branch (`git checkout -b feature/nueva-funcionalidad`)
3. Commit cambios (`git commit -am 'Agregar nueva funcionalidad'`)
4. Push a la branch (`git push origin feature/nueva-funcionalidad`)
5. Crear Pull Request

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT - ver el archivo [LICENSE](LICENSE) para detalles.

## üìû Soporte

Para soporte y preguntas:
- Email: support@barbersync.com
- Issues: [GitHub Issues](https://github.com/your-repo/issues)

---

**BarberSync Pro** - Revolucionando la gesti√≥n de barber√≠as üíà
